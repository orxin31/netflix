<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë„·í”Œë¦­ìŠ¤ ì´ë©”ì¼ ìë™ í™•ì¸ê¸°</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        ul { list-style-type: none; padding: 0; }
        li { padding: 5px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .highlight { font-weight: bold; color: #d81f26; }
        /* ì…ë ¥ì°½ ì˜ì—­ì€ ìˆ¨ê¹€ ì²˜ë¦¬ (ë˜ëŠ” ì‚­ì œ) */
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>

    <div class="box">
        <h2>â–¶ï¸ ë„·í”Œë¦­ìŠ¤ ìë™ í™•ì¸ ë´‡</h2>
        <p>â€» ì£¼ì˜: ë¸Œë¼ìš°ì €ì˜ <strong>íŒì—… ì°¨ë‹¨ì´ í•´ì œ</strong>ë˜ì–´ ìˆì–´ì•¼ êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì§„í–‰ë©ë‹ˆë‹¤. ì´ ì°½ì„ ë‹«ìœ¼ë©´ ì‘ë™ì´ ì¤‘ì§€ë©ë‹ˆë‹¤.</p>
        <button onclick="stopBot()" id="stopBtn">ë´‡ ì •ì§€</button>
        <button onclick="startBot()" id="manualStartBtn" style="display: none;">ìˆ˜ë™ìœ¼ë¡œ ë´‡ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div class="box">
        <h2>ğŸ“ ì´ë©”ì¼ í™•ì¸ ë‚´ì—­</h2>
        <ul id="emailHistory">
            </ul>
    </div>

    <script>
        // â˜… ì—¬ê¸°ì— ë³¸ì¸ì˜ êµ¬ê¸€ Client IDë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”! (ë”°ì˜´í‘œ ìœ ì§€)
        const MY_CLIENT_ID = '159608186065-d0v0vh3cejhed2m4h02hbjcjhfon2kqq.apps.googleusercontent.com'; 
        
        let botInterval;
        let tokenClient;
        let accessToken = null;
        let isGapiLoaded = false;

        // ì²˜ë¦¬ ë‚´ì—­ ì¶œë ¥ í•¨ìˆ˜ (ìµœì‹  ë‚´ì—­ì´ ìƒë‹¨ì— ì˜¤ë„ë¡ ìœ ì§€)
        function addHistory(message) {
            const historyList = document.getElementById('emailHistory');
            const newItem = document.createElement('li');
            const now = new Date().toLocaleTimeString();
            newItem.innerHTML = `[${now}] ${message}`;
            historyList.prepend(newItem); // ìµœê·¼ ë‚´ì—­ì´ ìœ„ë¡œ ì˜¬ë¼ê°€ê²Œ ì²˜ë¦¬
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ êµ¬ê¸€ API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ë° ìë™ ì‹¤í–‰
        window.onload = function() {
            addHistory("ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...");
            gapi.load('client', () => {
                gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
                }).then(() => {
                    isGapiLoaded = true;
                    addHistory("âœ… êµ¬ê¸€ API ë¡œë“œ ì™„ë£Œ. ìë™ ë¡œê·¸ì¸ì„ ì‹œë„í•©ë‹ˆë‹¤.");
                    // API ë¡œë“œê°€ ëë‚˜ë©´ ì¦‰ì‹œ ë´‡ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ (ìë™ ì‹¤í–‰)
                    startBot();
                });
            });
        };

        // ë´‡ ì‹œì‘ (êµ¬ê¸€ ë¡œê·¸ì¸ ë° ê¶Œí•œ íšë“)
        function startBot() {
            if(!isGapiLoaded) return;

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: MY_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/gmail.readonly',
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        document.getElementById('manualStartBtn').style.display = 'none';
                        document.getElementById('stopBtn').disabled = false;
                        addHistory("âœ… êµ¬ê¸€ ë¡œê·¸ì¸ ìŠ¹ì¸ ì™„ë£Œ. ë©”ì¼ ê°ì‹œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
                        
                        // 3ë¶„ë§ˆë‹¤ í™•ì¸ (í•„ìš”ì‹œ ì‹œê°„ ì¡°ì ˆ)
                        botInterval = setInterval(checkGmail, 180000);
                        checkGmail(); 
                    }
                },
                error_callback: (err) => {
                    addHistory("âš ï¸ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆê±°ë‚˜ ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ìˆ˜ë™ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                    document.getElementById('manualStartBtn').style.display = 'inline-block';
                }
            });

            // ê¶Œí•œ ìš”ì²­ íŒì—… ë„ìš°ê¸° (ìë™ ì‹¤í–‰ ì§€ì )
            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // ë´‡ ì •ì§€
        function stopBot() {
            clearInterval(botInterval);
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('manualStartBtn').style.display = 'inline-block';
            addHistory("ğŸ›‘ ìë™ í™•ì¸ì´ ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // Gmail APIë¡œ ìµœì‹  ì´ë©”ì¼ í™•ì¸
        async function checkGmail() {
            addHistory("ğŸ” ë„·í”Œë¦­ìŠ¤ ë©”ì¼ ê²€ìƒ‰ ì¤‘...");
            try {
                const response = await gapi.client.gmail.users.messages.list({
                    'userId': 'me',
                    'q': 'from:info@account.netflix.com',
                    'maxResults': 1
                });

                const messages = response.result.messages;
                if (!messages || messages.length === 0) {
                    addHistory("ìƒˆë¡œìš´ ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                const messageId = messages[0].id;
                await processEmail(messageId);
            } catch (error) {
                addHistory("âŒ ì´ë©”ì¼ ê²€ìƒ‰ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            }
        }

        // ì´ë©”ì¼ ë³¸ë¬¸ ì½ê¸° ë° ë§í¬ ì¶”ì¶œ
        async function processEmail(messageId) {
            try {
                const message = await gapi.client.gmail.users.messages.get({
                    'userId': 'me', 'id': messageId, 'format': 'full'
                });

                let bodyData = '';
                const parts = message.result.payload.parts;
                
                if (parts && parts.length > 0) {
                    const htmlPart = parts.find(part => part.mimeType === 'text/html');
                    bodyData = htmlPart ? htmlPart.body.data : parts[0].body.data;
                } else {
                    bodyData = message.result.payload.body.data;
                }

                if (!bodyData) return;

                const decodedBody = decodeURIComponent(escape(atob(bodyData.replace(/-/g, '+').replace(/_/g, '/'))));
                const linkRegex = /href="(https:\/\/www\.netflix\.com\/account\/update-primary-location\?nftoken=[^"]*)"/i;
                const match = decodedBody.match(linkRegex);

                if (match && match[1]) {
                    const authUrl = match[1];
                    addHistory(`<span class="highlight">ì¸ì¦ ë§í¬ ë°œê²¬! í´ë¦­ ì²˜ë¦¬í•©ë‹ˆë‹¤.</span>`);
                    window.open(authUrl, 'netflix_auth');
                } else {
                    addHistory("ë³¸ë¬¸ì—ì„œ ì¸ì¦ ë§í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                addHistory("âŒ ì´ë©”ì¼ ì½ê¸° ì˜¤ë¥˜ ë°œìƒ");
            }
        }
    </script>
</body>
</html>
