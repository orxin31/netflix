<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë„·í”Œë¦­ìŠ¤ ì´ë©”ì¼ ìë™ í™•ì¸ê¸°</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        ul { list-style-type: none; padding: 0; }
        li { padding: 5px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .highlight { font-weight: bold; color: #d81f26; }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>

    <div class="box">
        <h2>âš™ï¸ API ì„¤ì •</h2>
        <input type="text" id="clientId" placeholder="Google Client ID ì…ë ¥" style="width: 350px;">
        <button onclick="saveSettings()">ì„¤ì • ì €ì¥</button>
    </div>

    <div class="box">
        <h2>â–¶ï¸ ìë™í™” ì œì–´</h2>
        <p>â€» ì£¼ì˜: íŒì—… ì°¨ë‹¨ì´ í•´ì œë˜ì–´ ìˆì–´ì•¼ í•˜ë©°, ì´ ì°½ì„ ë‹«ìœ¼ë©´ ì‘ë™ì´ ì¤‘ì§€ë©ë‹ˆë‹¤.</p>
        <button onclick="startBot()" id="startBtn">ë´‡ ì‹œì‘ (êµ¬ê¸€ ë¡œê·¸ì¸)</button>
        <button onclick="stopBot()" id="stopBtn" disabled>ë´‡ ì •ì§€</button>
    </div>

    <div class="box">
        <h2>ğŸ“ ì´ë©”ì¼ í™•ì¸ ë‚´ì—­</h2>
        <ul id="emailHistory">
            </ul>
    </div>

    <script>
        let botInterval;
        let tokenClient;
        let accessToken = null;
        let isGapiLoaded = false;

        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ êµ¬ê¸€ API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ë° ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function() {
            const savedId = localStorage.getItem('googleClientId');
            if(savedId) document.getElementById('clientId').value = savedId;

            // gapi ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
            gapi.load('client', () => {
                gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
                }).then(() => {
                    isGapiLoaded = true;
                    addHistory("âœ… ì‹œìŠ¤í…œ: êµ¬ê¸€ API ë¡œë“œ ì™„ë£Œ. ë´‡ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                });
            });
        };

        // ì„¤ì • ì €ì¥ í•¨ìˆ˜
        function saveSettings() {
            const clientId = document.getElementById('clientId').value.trim();
            if(!clientId) {
                alert("Client IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            localStorage.setItem('googleClientId', clientId);
            alert('ì„¤ì •ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì²˜ë¦¬ ë‚´ì—­ ì¶œë ¥ í•¨ìˆ˜
        function addHistory(message) {
            const historyList = document.getElementById('emailHistory');
            const newItem = document.createElement('li');
            const now = new Date().toLocaleTimeString();
            newItem.innerHTML = `[${now}] ${message}`;
            
            // ìµœì‹  ë©”ì¼ ì²˜ë¦¬ ë‚´ì—­ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ëª©ë¡ ìƒë‹¨ì— ë³´ì´ë„ë¡ prepend ì‚¬ìš©
            historyList.prepend(newItem);
        }

        // 2. ë´‡ ì‹œì‘ (êµ¬ê¸€ ë¡œê·¸ì¸ ë° ê¶Œí•œ íšë“)
        function startBot() {
            const clientId = localStorage.getItem('googleClientId');
            if(!clientId) {
                alert("ë¨¼ì € API ì„¤ì •ì— Client IDë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if(!isGapiLoaded) {
                alert("êµ¬ê¸€ APIê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }

            // Google ì¸ì¦ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/gmail.readonly',
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                        addHistory("âœ… êµ¬ê¸€ ë¡œê·¸ì¸ ë° ê¶Œí•œ ìŠ¹ì¸ ì™„ë£Œ. ìë™ í™•ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
                        
                        // ì£¼ê¸°ì  í™•ì¸ ì‹¤í–‰ (ì˜ˆ: 3ë¶„ = 180000msë§ˆë‹¤)
                        botInterval = setInterval(checkGmail, 180000);
                        checkGmail(); // ì‹œì‘ ì¦‰ì‹œ 1íšŒ ì‹¤í–‰
                    }
                },
            });

            // ê¶Œí•œ ìš”ì²­ íŒì—… ë„ìš°ê¸°
            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // ë´‡ ì •ì§€
        function stopBot() {
            clearInterval(botInterval);
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            addHistory("ğŸ›‘ ìë™ í™•ì¸ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // 3. Gmail APIë¡œ ìµœì‹  ì´ë©”ì¼ í™•ì¸
        async function checkGmail() {
            addHistory("ğŸ” ë„·í”Œë¦­ìŠ¤ ë©”ì¼ ê²€ìƒ‰ ì¤‘...");
            try {
                // ìµœì‹  ë©”ì¼ 1ê°œë§Œ ê²€ìƒ‰
                const response = await gapi.client.gmail.users.messages.list({
                    'userId': 'me',
                    'q': 'from:info@account.netflix.com',
                    'maxResults': 1
                });

                const messages = response.result.messages;
                if (!messages || messages.length === 0) {
                    addHistory("ìƒˆë¡œìš´ ë„·í”Œë¦­ìŠ¤ ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const messageId = messages[0].id;
                await processEmail(messageId);

            } catch (error) {
                addHistory("âŒ ì´ë©”ì¼ ê²€ìƒ‰ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
                console.error(error);
            }
        }

        // 4. ì´ë©”ì¼ ë³¸ë¬¸ ì½ê¸° ë° ë§í¬ ì¶”ì¶œ
        async function processEmail(messageId) {
            try {
                const message = await gapi.client.gmail.users.messages.get({
                    'userId': 'me',
                    'id': messageId,
                    'format': 'full'
                });

                // ë³¸ë¬¸ ì¶”ì¶œ (Base64url ë””ì½”ë”©)
                let bodyData = '';
                const parts = message.result.payload.parts;
                
                if (parts && parts.length > 0) {
                    // HTML ë³¸ë¬¸ ì°¾ê¸°
                    const htmlPart = parts.find(part => part.mimeType === 'text/html');
                    if (htmlPart && htmlPart.body.data) {
                        bodyData = htmlPart.body.data;
                    } else {
                        bodyData = parts[0].body.data; // fallback
                    }
                } else {
                    bodyData = message.result.payload.body.data;
                }

                if (!bodyData) {
                    addHistory("ë³¸ë¬¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // Base64Url -> ì¼ë°˜ í…ìŠ¤íŠ¸ ë³€í™˜
                const decodedBody = decodeURIComponent(escape(atob(bodyData.replace(/-/g, '+').replace(/_/g, '/'))));

                // "ë„¤, ë³¸ì¸ì…ë‹ˆë‹¤" í˜¹ì€ íŠ¹ì • ë²„íŠ¼ì˜ ë§í¬ë¥¼ ì •ê·œì‹ìœ¼ë¡œ ì°¾ê¸°
                // ë„·í”Œë¦­ìŠ¤ ë©”ì¼ HTML êµ¬ì¡°ì— ë”°ë¼ "https://www.netflix.com/account/update..." í˜•íƒœì˜ ë§í¬ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                const linkRegex = /href="(https:\/\/[^"]*netflix\.com[^"]*)"/i;
                const match = decodedBody.match(linkRegex);

                if (match && match[1]) {
                    const authUrl = match[1];
                    addHistory(`<span class="highlight">ì¸ì¦ ë§í¬ ë°œê²¬! í´ë¦­ì„ ì‹œë„í•©ë‹ˆë‹¤.</span>`);
                    
                    // ìƒˆ íƒ­(íŒì—…)ìœ¼ë¡œ ë§í¬ ì—´ì–´ ìë™ í´ë¦­ ëŒ€ì²´
                    // ë™ì¼í•œ ì´ë¦„ì˜ ì°½('netflix_auth')ì„ ì‚¬ìš©í•˜ì—¬ ì°½ì´ ë¬´í•œì • ëŠ˜ì–´ë‚˜ëŠ” ê²ƒì„ ë°©ì§€
                    window.open(authUrl, 'netflix_auth');
                    addHistory("ì¸ì¦ í˜ì´ì§€ë¥¼ ìƒˆ ì°½ìœ¼ë¡œ ì—´ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    addHistory("ë©”ì¼ ë³¸ë¬¸ì—ì„œ ì¸ì¦ ë§í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

            } catch (error) {
                addHistory("âŒ ì´ë©”ì¼ ì½ê¸° ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            }
        }
    </script>
</body>
</html>
